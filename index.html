<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background: #1e1e1e; /* Fundo mais escuro */
            color: #e0e0e0; /* Texto mais neutro */
        }
        h1 {
            color: #e0e0e0;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }
        .input-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px 0 0 5px;
            background-color: #333;
            color: #e0e0e0;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            min-width: 200px;
        }
        input[type="text"]:focus {
            border-color: #888;
            box-shadow: 0 0 10px rgba(136, 136, 136, 0.2);
        }
        button {
            padding: 12px;
            background-color: #888;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }
        button:disabled {
            background-color: #444;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #result-container {
            margin-top: 30px;
            display: none;
        }
        #result {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            max-width: 90%;
            margin: 0 auto;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #history {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }
        #history img {
            width: 100%;
            max-width: 200px;
            height: auto;
            object-fit: cover;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #history img:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .refresh-button {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            color: #888;
            transition: color 0.3s;
        }
        .refresh-button:hover {
            color: #666;
        }
        .history-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        p {
            margin: 10px 0;
            color: #ccc;
        }
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #888;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #888;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .mode-label {
            margin-left: 10px;
            vertical-align: super;
            color: #ccc;
            font-size: 14px;
        }

        .prompt-toggle {
            position: absolute;
            bottom: 10px;
            left: 10px;
            cursor: pointer;
            font-size: 24px;
            color: #888;
        }

        .prompt-toggle:hover {
            color: #666;
        }

        @media (max-width: 600px) {
            #result img {
                max-width: 100%;
                height: auto;
            }
        }

        @media (min-width: 601px) {
            #result img {
                max-width: 60%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <h1>Flux</h1>
    <div class="input-container">
        <input type="text" id="prompt" placeholder="Imagine sua imagem aqui">
        <button id="generateButton" onclick="generateOrEnhanceImage()">🎨</button> <!-- Atualizado para um ícone mais elegante -->
        <label class="toggle-switch">
            <input type="checkbox" id="enhanceToggle" checked>
            <span class="slider"></span>
        </label>
        <span class="mode-label">✨</span>
    </div>
    <div id="result-container">
        <div id="result"></div>
    </div>
    <div id="history"></div>
    <div class="history-header">
        <h2>Histórico de Imagens</h2>
        <button class="refresh-button" onclick="confirmClearHistory()" title="Limpar histórico">🔄</button> <!-- Atualizado para um ícone mais elegante -->
    </div>

    <script>
        const HF_TOKEN = "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";

        async function queryImageGeneration(data) {
            const response = await fetch(
                "https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-dev",
                {
                    headers: {
                        Authorization: `Bearer ${HF_TOKEN}`,
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify(data),
                }
            );
            if (!response.ok) {
                throw new Error('Erro na consulta ao modelo de geração de imagens');
            }
            const result = await response.blob();
            return result;
        }

        async function queryPromptEnhancement(userPrompt) {
            const response = await fetch(
                "https://api-inference.huggingface.co/models/meta-llama/Meta-Llama-3-8B-Instruct",
                {
                    headers: {
                        Authorization: `Bearer ${HF_TOKEN}`,
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify({
                        inputs: `You are an AI artist. Transform the user's prompt into a detailed and vivid visual description for image generation. Describe the image to be created, including colors, composition, and atmosphere. Write in English. Do not mention painting styles, image sizes, or other unnecessary details. Ensure the description is concise and complete, not exceeding 100 words.

User's prompt: "${userPrompt}"

Visual description:`,
                        parameters: {
                            max_new_tokens: 150,
                            return_full_text: false,
                            temperature: 0.8,
                            top_p: 0.95,
                        },
                    }),
                }
            );
            if (!response.ok) {
                throw new Error('Error querying the prompt enhancement model');
            }
            const result = await response.json();
            let enhancedPrompt = result[0]?.generated_text?.trim() || '';
            
            // Remove any unwanted prefixes or instructions
            enhancedPrompt = enhancedPrompt.replace(/^(Enhanced prompt:|Response:|Visual description:)\s*/i, '');
            enhancedPrompt = enhancedPrompt.replace(/^.*\(.*\).*$/m, '');
            
            // Ensure the prompt is complete and concise
            if (enhancedPrompt.endsWith('...')) {
                const lastPeriodIndex = enhancedPrompt.lastIndexOf('.');
                if (lastPeriodIndex !== -1) {
                    enhancedPrompt = enhancedPrompt.slice(0, lastPeriodIndex + 1).trim();
                } else {
                    enhancedPrompt = enhancedPrompt.slice(0, -3).trim();
                }
            }
            
            // Limit the prompt to 100 words
            const words = enhancedPrompt.split(' ');
            if (words.length > 100) {
                enhancedPrompt = words.slice(0, 100).join(' ').trim();
            }
            
            // Ensure the prompt does not end abruptly
            if (enhancedPrompt.endsWith(',')) {
                enhancedPrompt = enhancedPrompt.slice(0, -1).trim();
            }
            
            return enhancedPrompt;
        }

        let imageHistory = JSON.parse(localStorage.getItem('imageHistory')) || [];

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function updateHistory(imageBlob, prompt) {
            const base64Image = await blobToBase64(imageBlob);
            imageHistory.unshift({ url: base64Image, prompt: prompt });
            if (imageHistory.length > 20) {
                imageHistory.pop();
            }
            localStorage.setItem('imageHistory', JSON.stringify(imageHistory));
            displayHistory();
        }

        function displayHistory() {
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '';
            imageHistory.forEach((item, index) => {
                const img = document.createElement('img');
                img.src = item.url;
                img.alt = `Imagem ${index + 1}`;
                img.title = item.prompt;
                img.onclick = () => showFullImage(item.url, item.prompt);
                historyDiv.appendChild(img);
            });
        }

        function showFullImage(url, prompt) {
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            resultContainer.style.display = 'block';
            resultDiv.innerHTML = `
                <img src="${url}" alt="Imagem em tamanho completo">
                <p id="promptText" style="display: none;">Prompt: ${prompt}</p>
                <div class="prompt-toggle" onclick="togglePromptVisibility()">👁️</div>
            `;
        }

        function togglePromptVisibility() {
            const promptText = document.getElementById('promptText');
            if (promptText) {
                promptText.style.display = promptText.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showLoading(message) {
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            resultContainer.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="loading"></div>
                <p>${message}</p>
            `;
        }

        async function generateOrEnhanceImage() {
            const userPrompt = document.getElementById('prompt').value.trim();
            if (!userPrompt) {
                alert('Por favor, insira um prompt.');
                return;
            }
            const enhanceMode = document.getElementById('enhanceToggle').checked;
            const generateButton = document.getElementById('generateButton');
            
            // Desativar o botão de geração de imagem
            generateButton.disabled = true;
            
            if (enhanceMode) {
                await enhanceAndGenerateImage(userPrompt);
            } else {
                await generateImage(userPrompt);
            }
            
            // Reativar o botão de geração de imagem
            generateButton.disabled = false;
        }

        async function enhanceAndGenerateImage(userPrompt) {
            showLoading('Aprimorando o prompt...');
            
            try {
                const enhancedPrompt = await queryPromptEnhancement(userPrompt);
                if (!enhancedPrompt) {
                    throw new Error('Prompt aprimorado vazio');
                }
                showLoading('Gerando imagem com o prompt aprimorado...');
                
                const response = await queryImageGeneration({"inputs": enhancedPrompt});
                const imageUrl = URL.createObjectURL(response);
                const resultContainer = document.getElementById('result-container');
                const resultDiv = document.getElementById('result');
                resultContainer.style.display = 'block';
                resultDiv.innerHTML = `
                    <img src="${imageUrl}" alt="Imagem gerada">
                    <p id="promptText" style="display: none;">Prompt original: ${userPrompt}<br>Prompt aprimorado (em inglês): ${enhancedPrompt}</p>
                    <div class="prompt-toggle" onclick="togglePromptVisibility()">👁️</div>
                `;
                await updateHistory(response, enhancedPrompt);
            } catch (error) {
                document.getElementById('result').innerHTML = 'Erro ao gerar a imagem. Por favor, tente novamente.';
                console.error('Erro:', error);
            }
        }

        async function generateImage(prompt) {
            showLoading('Gerando imagem...');
            
            try {
                const response = await queryImageGeneration({"inputs": prompt});
                const imageUrl = URL.createObjectURL(response);
                const resultContainer = document.getElementById('result-container');
                const resultDiv = document.getElementById('result');
                resultContainer.style.display = 'block';
                resultDiv.innerHTML = `
                    <img src="${imageUrl}" alt="Imagem gerada">
                    <p id="promptText" style="display: none;">Prompt: ${prompt}</p>
                    <div class="prompt-toggle" onclick="togglePromptVisibility()">👁️</div>
                `;
                await updateHistory(response, prompt);
            } catch (error) {
                document.getElementById('result').innerHTML = 'Erro ao gerar a imagem. Por favor, tente novamente.';
                console.error('Erro:', error);
            }
        }

        function confirmClearHistory() {
            if (confirm('Tem certeza de que deseja limpar o histórico?')) {
                clearHistory();
            }
        }

        function clearHistory() {
            imageHistory = [];
            localStorage.removeItem('imageHistory');
            displayHistory();
        }

        // Exibir o histórico ao carregar a página
        displayHistory();

        // Adicione esta função para lidar com o evento de tecla pressionada
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                generateOrEnhanceImage();
            }
        }

        // Adicione um event listener para o campo de entrada
        document.getElementById('prompt').addEventListener('keypress', handleKeyPress);
    </script>
</body>
</html>
