<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background: #333;
            color: #f5f5f5;
        }
        h1 {
            color: #f5f5f5;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }
        .input-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 5px 0 0 5px;
            background-color: #444;
            color: #f5f5f5;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus {
            border-color: #00b894;
            box-shadow: 0 0 10px rgba(0, 184, 148, 0.2);
        }
        button {
            padding: 12px;
            background-color: #00b894;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #019875;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #result-container {
            margin-top: 30px;
            display: none;
        }
        #result {
            background-color: #444;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #history {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }
        #history img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #history img:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .refresh-button {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            color: #00b894;
            transition: color 0.3s;
        }
        .refresh-button:hover {
            color: #019875;
        }
        .history-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        p {
            margin: 10px 0;
            color: #ccc;
        }
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #00b894;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00b894;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .mode-label {
            margin-left: 10px;
            vertical-align: super;
            color: #ccc;
            font-size: 14px;
        }

        .prompt-toggle {
            position: absolute;
            bottom: 10px;
            left: 10px;
            cursor: pointer;
            font-size: 24px;
            color: #00b894;
        }

        .prompt-toggle:hover {
            color: #019875;
        }
    </style>
</head>
<body>
    <h1>Flux</h1>
    <div class="input-container">
        <input type="text" id="prompt" placeholder="Imagine sua imagem aqui">
        <button id="generateButton" onclick="generateOrEnhanceImage()">üñåÔ∏è</button>
        <label class="toggle-switch">
            <input type="checkbox" id="enhanceToggle" checked>
            <span class="slider"></span>
        </label>
        <span class="mode-label">‚ú®</span>
    </div>
    <div id="result-container">
        <div id="result"></div>
    </div>
    <div id="history"></div>
    <div class="history-header">
        <h2>Hist√≥rico de Imagens</h2>
        <button class="refresh-button" onclick="confirmClearHistory()" title="Limpar hist√≥rico">üîÑ</button>
    </div>

    <script>
        const HF_TOKEN = "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";

        async function queryImageGeneration(data) {
            const response = await fetch(
                "https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-dev",
                {
                    headers: {
                        Authorization: `Bearer ${HF_TOKEN}`,
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify(data),
                }
            );
            if (!response.ok) {
                throw new Error('Erro na consulta ao modelo de gera√ß√£o de imagens');
            }
            const result = await response.blob();
            return result;
        }

        async function queryPromptEnhancement(userPrompt) {
            const response = await fetch(
                "https://api-inference.huggingface.co/models/meta-llama/Meta-Llama-3-8B-Instruct",
                {
                    headers: {
                        Authorization: `Bearer ${HF_TOKEN}`,
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify({
                        inputs: `You are an AI artist specialized in creating detailed and vivid visual descriptions for image generation. Your task is to transform the user's prompt into an artistic masterpiece. Follow these instructions:

1. Use the user's prompt as inspiration to create a detailed and vivid visual description.
2. Be creative and imaginative, adding artistic elements and details.
3. Include descriptions of colors, composition, artistic style, and atmosphere.
4. If the prompt is abstract, create a concrete visual representation.
5. Write in English, without using quotation marks.
6. Do not include phrases like "Enhanced prompt:" or "Response:".
7. Do not ask the user to complete or respond to anything.
8. Start immediately with the image description.

User's prompt: "${userPrompt}"

Visual description:`,
                        parameters: {
                            max_new_tokens: 150,
                            return_full_text: false,
                            temperature: 0.8,
                            top_p: 0.95,
                        },
                    }),
                }
            );
            if (!response.ok) {
                throw new Error('Erro na consulta ao modelo de aprimoramento de prompts');
            }
            const result = await response.json();
            let enhancedPrompt = result[0]?.generated_text?.trim() || '';
            
            // Remove any unwanted prefixes or instructions
            enhancedPrompt = enhancedPrompt.replace(/^(Enhanced prompt:|Response:|Visual description:)\s*/i, '');
            enhancedPrompt = enhancedPrompt.replace(/^.*\(.*\).*$/m, '');
            
            return enhancedPrompt;
        }

        let imageHistory = JSON.parse(localStorage.getItem('imageHistory')) || [];

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function updateHistory(imageBlob, prompt) {
            const base64Image = await blobToBase64(imageBlob);
            imageHistory.unshift({ url: base64Image, prompt: prompt });
            if (imageHistory.length > 20) {
                imageHistory.pop();
            }
            localStorage.setItem('imageHistory', JSON.stringify(imageHistory));
            displayHistory();
        }

        function displayHistory() {
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '';
            imageHistory.forEach((item, index) => {
                const img = document.createElement('img');
                img.src = item.url;
                img.alt = `Imagem ${index + 1}`;
                img.title = item.prompt;
                img.onclick = () => showFullImage(item.url, item.prompt);
                historyDiv.appendChild(img);
            });
        }

        function showFullImage(url, prompt) {
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            resultContainer.style.display = 'block';
            resultDiv.innerHTML = `
                <img src="${url}" alt="Imagem em tamanho completo">
                <p id="promptText" style="display: none;">Prompt: ${prompt}</p>
                <div class="prompt-toggle" onclick="togglePromptVisibility()">üëÅÔ∏è</div>
            `;
        }

        function togglePromptVisibility() {
            const promptText = document.getElementById('promptText');
            if (promptText) {
                promptText.style.display = promptText.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showLoading(message) {
            const resultContainer = document.getElementById('result-container');
            const resultDiv = document.getElementById('result');
            resultContainer.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="loading"></div>
                <p>${message}</p>
            `;
        }

        async function generateOrEnhanceImage() {
            const userPrompt = document.getElementById('prompt').value.trim();
            if (!userPrompt) {
                alert('Por favor, insira um prompt.');
                return;
            }
            const enhanceMode = document.getElementById('enhanceToggle').checked;
            const generateButton = document.getElementById('generateButton');
            
            // Desativar o bot√£o de gera√ß√£o de imagem
            generateButton.disabled = true;
            
            if (enhanceMode) {
                await enhanceAndGenerateImage(userPrompt);
            } else {
                await generateImage(userPrompt);
            }
            
            // Reativar o bot√£o de gera√ß√£o de imagem
            generateButton.disabled = false;
        }

        async function enhanceAndGenerateImage(userPrompt) {
            showLoading('Aprimorando o prompt...');
            
            try {
                const enhancedPrompt = await queryPromptEnhancement(userPrompt);
                if (!enhancedPrompt) {
                    throw new Error('Prompt aprimorado vazio');
                }
                showLoading('Gerando imagem com o prompt aprimorado...');
                
                const response = await queryImageGeneration({"inputs": enhancedPrompt});
                const imageUrl = URL.createObjectURL(response);
                const resultContainer = document.getElementById('result-container');
                const resultDiv = document.getElementById('result');
                resultContainer.style.display = 'block';
                resultDiv.innerHTML = `
                    <img src="${imageUrl}" alt="Imagem gerada">
                    <p id="promptText" style="display: none;">Prompt original: ${userPrompt}<br>Prompt aprimorado (em ingl√™s): ${enhancedPrompt}</p>
                    <div class="prompt-toggle" onclick="togglePromptVisibility()">üëÅÔ∏è</div>
                `;
                await updateHistory(response, enhancedPrompt);
            } catch (error) {
                document.getElementById('result').innerHTML = 'Erro ao gerar a imagem. Por favor, tente novamente.';
                console.error('Erro:', error);
            }
        }

        async function generateImage(prompt) {
            showLoading('Gerando imagem...');
            
            try {
                const response = await queryImageGeneration({"inputs": prompt});
                const imageUrl = URL.createObjectURL(response);
                const resultContainer = document.getElementById('result-container');
                const resultDiv = document.getElementById('result');
                resultContainer.style.display = 'block';
                resultDiv.innerHTML = `
                    <img src="${imageUrl}" alt="Imagem gerada">
                    <p id="promptText" style="display: none;">Prompt: ${prompt}</p>
                    <div class="prompt-toggle" onclick="togglePromptVisibility()">üëÅÔ∏è</div>
                `;
                await updateHistory(response, prompt);
            } catch (error) {
                document.getElementById('result').innerHTML = 'Erro ao gerar a imagem. Por favor, tente novamente.';
                console.error('Erro:', error);
            }
        }

        function confirmClearHistory() {
            if (confirm('Tem certeza de que deseja limpar o hist√≥rico?')) {
                clearHistory();
            }
        }

        function clearHistory() {
            imageHistory = [];
            localStorage.removeItem('imageHistory');
            displayHistory();
        }

        // Exibir o hist√≥rico ao carregar a p√°gina
        displayHistory();

        // Adicione esta fun√ß√£o para lidar com o evento de tecla pressionada
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                generateOrEnhanceImage();
            }
        }

        // Adicione um event listener para o campo de entrada
        document.getElementById('prompt').addEventListener('keypress', handleKeyPress);
    </script>
</body>
</html>
